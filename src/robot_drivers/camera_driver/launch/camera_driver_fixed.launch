<launch>
  <!-- USB-optimized multi-camera launch for RealSense cameras -->
  <!-- Addresses USB bandwidth limitations and endpoint conflicts -->
  
  <!-- Serial numbers of the RealSense cameras -->
  <arg name="serial_no_camera1" default="337122071540"/>  <!-- chassis camera -->
  <arg name="serial_no_camera2" default="337122071190"/>  <!-- hand camera -->
  <arg name="serial_no_camera3" default="318122302992"/>  <!-- top camera -->
  
  <arg name="camera1" default="camera/chassis"/>
  <arg name="camera2" default="camera/hand"/>
  <arg name="camera3" default="camera/top"/>
  
  <arg name="tf_prefix_camera1" default="$(arg camera1)"/>
  <arg name="tf_prefix_camera2" default="$(arg camera2)"/>
  <arg name="tf_prefix_camera3" default="$(arg camera3)"/>
  
  <!-- Conservative USB settings -->
  <arg name="initial_reset" default="false"/>
  <arg name="reconnect_timeout" default="15.0"/>
  
  <!-- Enable/disable cameras individually -->
  <arg name="enable_camera1" default="true"/>
  <arg name="enable_camera2" default="true"/>
  <arg name="enable_camera3" default="true"/>
  
  <!-- USB-optimized configuration - reduced bandwidth -->
  <arg name="enable_depth" default="false"/>
  <arg name="enable_infra1" default="false"/>
  <arg name="enable_infra2" default="false"/>
  <arg name="enable_color" default="true"/>
  <arg name="enable_fisheye" default="false"/>
  <arg name="enable_fisheye1" default="false"/>
  <arg name="enable_fisheye2" default="false"/>
  <arg name="enable_gyro" default="false"/>
  <arg name="enable_accel" default="false"/>
  <arg name="enable_pose" default="false"/>
  <arg name="enable_confidence" default="false"/>
  
  <!-- Reduced resolution and framerate to prevent USB overload -->
  <arg name="color_width" default="640"/>
  <arg name="color_height" default="480"/>
  <arg name="color_fps" default="15"/>  <!-- Reduced from 30 to 15 -->
  
  <!-- RViz visualization option -->
  <arg name="rviz" default="false"/>
  <arg name="rviz_config" default="$(find camera_driver)/config/camera_driver.rviz"/>
  
  <!-- Camera 1 (chassis) - Start first -->
  <group ns="$(arg camera1)" if="$(arg enable_camera1)">
    <include file="$(find realsense2_camera)/launch/includes/nodelet.launch.xml">
      <arg name="serial_no" value="$(arg serial_no_camera1)"/>
      <arg name="tf_prefix" value="$(arg tf_prefix_camera1)"/>
      <arg name="initial_reset" value="$(arg initial_reset)"/>
      <arg name="reconnect_timeout" value="$(arg reconnect_timeout)"/>
      
      <arg name="enable_depth" value="$(arg enable_depth)"/>
      <arg name="enable_infra1" value="$(arg enable_infra1)"/>
      <arg name="enable_infra2" value="$(arg enable_infra2)"/>
      <arg name="enable_color" value="$(arg enable_color)"/>
      <arg name="enable_fisheye" value="$(arg enable_fisheye)"/>
      <arg name="enable_fisheye1" value="$(arg enable_fisheye1)"/>
      <arg name="enable_fisheye2" value="$(arg enable_fisheye2)"/>
      <arg name="enable_gyro" value="$(arg enable_gyro)"/>
      <arg name="enable_accel" value="$(arg enable_accel)"/>
      <arg name="enable_pose" value="$(arg enable_pose)"/>
      <arg name="enable_confidence" value="$(arg enable_confidence)"/>
      
      <arg name="color_width" value="$(arg color_width)"/>
      <arg name="color_height" value="$(arg color_height)"/>
      <arg name="color_fps" value="$(arg color_fps)"/>
    </include>
  </group>
  
  <!-- Add delay before starting camera 2 -->
  <node pkg="rosservice" type="rosservice" name="delay_camera2" 
        args="call --wait /camera/chassis/realsense2_camera_manager/list_nodelets" 
        if="$(eval enable_camera1 and enable_camera2)" />
  
  <!-- Camera 2 (hand) - Start with delay -->
  <group ns="$(arg camera2)" if="$(arg enable_camera2)">
    <include file="$(find realsense2_camera)/launch/includes/nodelet.launch.xml">
      <arg name="serial_no" value="$(arg serial_no_camera2)"/>
      <arg name="tf_prefix" value="$(arg tf_prefix_camera2)"/>
      <arg name="initial_reset" value="$(arg initial_reset)"/>
      <arg name="reconnect_timeout" value="$(arg reconnect_timeout)"/>
      
      <arg name="enable_depth" value="$(arg enable_depth)"/>
      <arg name="enable_infra1" value="$(arg enable_infra1)"/>
      <arg name="enable_infra2" value="$(arg enable_infra2)"/>
      <arg name="enable_color" value="$(arg enable_color)"/>
      <arg name="enable_fisheye" value="$(arg enable_fisheye)"/>
      <arg name="enable_fisheye1" value="$(arg enable_fisheye1)"/>
      <arg name="enable_fisheye2" value="$(arg enable_fisheye2)"/>
      <arg name="enable_gyro" value="$(arg enable_gyro)"/>
      <arg name="enable_accel" value="$(arg enable_accel)"/>
      <arg name="enable_pose" value="$(arg enable_pose)"/>
      <arg name="enable_confidence" value="$(arg enable_confidence)"/>
      
      <arg name="color_width" value="$(arg color_width)"/>
      <arg name="color_height" value="$(arg color_height)"/>
      <arg name="color_fps" value="$(arg color_fps)"/>
    </include>
  </group>
  
  <!-- Add delay before starting camera 3 -->
  <node pkg="rosservice" type="rosservice" name="delay_camera3" 
        args="call --wait /camera/hand/realsense2_camera_manager/list_nodelets"
        if="$(eval enable_camera2 and enable_camera3)" />
  
  <!-- Camera 3 (top) - Start last -->
  <group ns="$(arg camera3)" if="$(arg enable_camera3)">
    <include file="$(find realsense2_camera)/launch/includes/nodelet.launch.xml">
      <arg name="serial_no" value="$(arg serial_no_camera3)"/>
      <arg name="tf_prefix" value="$(arg tf_prefix_camera3)"/>
      <arg name="initial_reset" value="$(arg initial_reset)"/>
      <arg name="reconnect_timeout" value="$(arg reconnect_timeout)"/>
      
      <arg name="enable_depth" value="$(arg enable_depth)"/>
      <arg name="enable_infra1" value="$(arg enable_infra1)"/>
      <arg name="enable_infra2" value="$(arg enable_infra2)"/>
      <arg name="enable_color" value="$(arg enable_color)"/>
      <arg name="enable_fisheye" value="$(arg enable_fisheye)"/>
      <arg name="enable_fisheye1" value="$(arg enable_fisheye1)"/>
      <arg name="enable_fisheye2" value="$(arg enable_fisheye2)"/>
      <arg name="enable_gyro" value="$(arg enable_gyro)"/>
      <arg name="enable_accel" value="$(arg enable_accel)"/>
      <arg name="enable_pose" value="$(arg enable_pose)"/>
      <arg name="enable_confidence" value="$(arg enable_confidence)"/>
      
      <arg name="color_width" value="$(arg color_width)"/>
      <arg name="color_height" value="$(arg color_height)"/>
      <arg name="color_fps" value="$(arg color_fps)"/>
    </include>
  </group>

  <!-- Launch RViz if requested -->
  <group if="$(arg rviz)">
    <node name="rviz" pkg="rviz" type="rviz" args="-d $(arg rviz_config)" output="screen"/>
  </group>
  
</launch>